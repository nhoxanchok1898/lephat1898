{% extends "admin/base_site.html" %}
{% load humanize %}

{% block title %}Revenue Report{% endblock %}

{% block content %}
<div class="container-fluid container-wide">
  <h1 class="mt-3">Revenue Report (Paid Orders)</h1>
  <p class="text-muted">Chỉ đọc – hiển thị doanh thu từ các đơn đã thanh toán (is_paid=True).</p>

  <form method="get" class="row g-2 align-items-end mb-3">
    <div class="col-md-3">
      <label class="form-label">Từ ngày</label>
      <input type="date" name="from_date" value="{{ from_date }}" class="form-control">
    </div>
    <div class="col-md-3">
      <label class="form-label">Đến ngày</label>
      <input type="date" name="to_date" value="{{ to_date }}" class="form-control">
    </div>
    <div class="col-md-3">
      <label class="form-label">Nhanh</label>
      <select name="preset" class="form-select">
        <option value="" {% if not preset %}selected{% endif %}>-- Chọn --</option>
        <option value="last_7" {% if preset == 'last_7' %}selected{% endif %}>7 ngày gần đây</option>
        <option value="last_30" {% if preset == 'last_30' %}selected{% endif %}>30 ngày gần đây</option>
        <option value="this_month" {% if preset == 'this_month' %}selected{% endif %}>Tháng này</option>
      </select>
    </div>
    <div class="col-md-3 d-flex gap-2">
      <button type="submit" class="btn btn-primary mt-auto">Lọc</button>
      <a href="{% url 'store:revenue_report' %}" class="btn btn-outline-secondary mt-auto">Xóa lọc</a>
    </div>
  </form>

  <div class="row g-3 my-3">
    <div class="col-md-4">
      <div class="card p-3">
        <div class="text-muted small">Tổng doanh thu</div>
        <div class="h4 mb-0">{{ total_revenue|default:0|floatformat:2|intcomma }}</div>
        {% if period_change and period_change.revenue_pct is not None %}
          <div class="text-muted small">
            So với kỳ trước: <strong>{{ period_change.revenue_pct|floatformat:1 }}%</strong>
          </div>
        {% endif %}
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <div class="text-muted small">Số đơn đã thanh toán</div>
        <div class="h4 mb-0">{{ order_count }}</div>
        {% if period_change and period_change.orders_pct is not None %}
          <div class="text-muted small">
            So với kỳ trước: <strong>{{ period_change.orders_pct|floatformat:1 }}%</strong>
          </div>
        {% endif %}
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <div class="text-muted small">Giá trị đơn trung bình</div>
        <div class="h4 mb-0">{{ avg_order_value|floatformat:2|intcomma }}</div>
        {% if period_change and period_change.aov_pct is not None %}
          <div class="text-muted small">
            So với kỳ trước: <strong>{{ period_change.aov_pct|floatformat:1 }}%</strong>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="mb-3 d-flex gap-2">
    {% with params=request.GET.urlencode %}
    <a class="btn btn-sm btn-outline-primary" href="{% url 'store:export_revenue_csv' %}?{{ params }}">Tải CSV</a>
    <a class="btn btn-sm btn-outline-secondary" href="{% url 'store:export_revenue_xlsx' %}?{{ params }}">Tải XLSX</a>
    {% endwith %}
  </div>

  <div class="card mb-4">
    <div class="card-header fw-bold">Gửi báo cáo qua email</div>
    <div class="card-body">
      <form method="post" action="{% url 'store:email_revenue_report' %}">
        {% csrf_token %}
        <div class="row g-3 align-items-end">
          <div class="col-md-5">
            <label class="form-label">Email nhận</label>
            <input type="email" name="recipient" class="form-control" required placeholder="accounting@example.com">
          </div>
          <div class="col-md-3">
            <label class="form-label">Định dạng</label>
            <select name="format" class="form-select">
              <option value="csv">CSV</option>
              <option value="xlsx">XLSX</option>
            </select>
          </div>
          <div class="col-md-4 d-flex gap-2">
            <button type="submit" class="btn btn-primary mt-auto">Gửi email</button>
          </div>
        </div>
        <!-- preserve filters -->
        <input type="hidden" name="from_date" value="{{ from_date }}">
        <input type="hidden" name="to_date" value="{{ to_date }}">
        <input type="hidden" name="preset" value="{{ preset }}">
      </form>
      <p class="text-muted small mb-0 mt-2">Email sẽ đính kèm báo cáo dựa trên bộ lọc ngày hiện tại.</p>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header fw-bold">Doanh thu theo ngày</div>
    <div class="table-responsive">
      <table class="table table-sm mb-0">
        <thead>
          <tr>
            <th>Ngày</th>
            <th class="text-end">Tổng</th>
            <th class="text-end">Số đơn</th>
          </tr>
        </thead>
        <tbody>
        {% for row in daily_totals %}
          <tr>
            <td>{{ row.day|date:"Y-m-d" }}</td>
            <td class="text-end">{{ row.total|floatformat:2|intcomma }}</td>
            <td class="text-end">{{ row.orders }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="3" class="text-center text-muted">Chưa có đơn đã thanh toán.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header fw-bold">Doanh thu theo tháng</div>
    <div class="table-responsive">
      <table class="table table-sm mb-0">
        <thead>
          <tr>
            <th>Tháng</th>
            <th class="text-end">Tổng</th>
            <th class="text-end">Số đơn</th>
          </tr>
        </thead>
        <tbody>
        {% for row in monthly_totals %}
          <tr>
            <td>{{ row.month|date:"Y-m" }}</td>
            <td class="text-end">{{ row.total|floatformat:2|intcomma }}</td>
            <td class="text-end">{{ row.orders }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="3" class="text-center text-muted">Chưa có đơn đã thanh toán.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header fw-bold">Top sản phẩm (theo doanh thu)</div>
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <thead>
              <tr>
                <th>Sản phẩm</th>
                <th class="text-end">Doanh thu</th>
                <th class="text-end">Số lượng</th>
              </tr>
            </thead>
            <tbody>
            {% for p in top_products %}
              <tr>
                <td>{{ p.product__name }}</td>
                <td class="text-end">{{ p.total_revenue|floatformat:2|intcomma }}</td>
                <td class="text-end">{{ p.total_qty }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="3" class="text-center text-muted">Chưa có dữ liệu.</td></tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header fw-bold">Top khách hàng (theo chi tiêu)</div>
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <thead>
              <tr>
                <th>Khách</th>
                <th class="text-end">Tổng chi</th>
                <th class="text-end">Số đơn</th>
              </tr>
            </thead>
            <tbody>
            {% for c in top_customers %}
              <tr>
                <td>{{ c.user__username|default:c.user__email }}</td>
                <td class="text-end">{{ c.total_spend|floatformat:2|intcomma }}</td>
                <td class="text-end">{{ c.orders }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="3" class="text-center text-muted">Chưa có dữ liệu.</td></tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="card mt-4">
    <div class="card-header fw-bold">Doanh thu theo phương thức thanh toán</div>
    <div class="table-responsive">
      <table class="table table-sm mb-0">
        <thead>
          <tr>
            <th>Phương thức</th>
            <th class="text-end">Doanh thu</th>
            <th class="text-end">Số đơn</th>
          </tr>
        </thead>
        <tbody>
        {% for pm in payment_breakdown %}
          <tr>
            <td>{{ pm.payment_method|title }}</td>
            <td class="text-end">{{ pm.total|floatformat:2|intcomma }}</td>
            <td class="text-end">{{ pm.orders }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="3" class="text-center text-muted">Chưa có dữ liệu.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
