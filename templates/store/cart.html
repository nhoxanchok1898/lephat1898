{% extends 'store/base.html' %}
{% load static %}
{% load watermark_extras %}
{% load price_extras %}
{% block title %}Giỏ hàng - Đại lý Sơn Phát Tấn{% endblock %}
{% block content %}
<section class="page-section cart-page">
  <div class="section-heading">
    <h2 class="section-title">Giỏ hàng của bạn</h2>
    <p class="section-sub">{% if items %}{{ items|length }} sản phẩm{% else %}Chưa có sản phẩm{% endif %}</p>
  </div>

  {% if items %}
  <div class="cart-grid">
    <div class="cart-items">
      {% for it in items %}
      <article class="cart-item">
        <div class="cart-item__thumb">
          {% if it.product.image %}
            <img src="{{ it.product.image|watermarked }}" alt="{{ it.product.name }}">
          {% else %}
            <img src="{% static 'images/product-placeholder.svg' %}" alt="Chưa có ảnh">
          {% endif %}
        </div>
        <div class="cart-item__info">
          <div class="cart-item__title">{{ it.product.name }}</div>
          {% if it.product.brand %}<div class="cart-item__brand">{{ it.product.brand.name }}</div>{% endif %}
          <div class="cart-item__price">Đơn giá: {{ it.product.price|vnd }}</div>
          <div class="cart-item__subtotal">Tạm tính: {{ it.subtotal|vnd }}</div>
          <form method="post" action="{% url 'store:cart_update' it.product.pk %}" class="cart-item__qty">
            {% csrf_token %}
            <label for="qty-{{ it.product.pk }}" class="form-label">Số lượng</label>
            <div class="qty-inline">
              <button type="button" class="btn btn-outline qty-decrement" aria-label="Giảm">−</button>
              <input id="qty-{{ it.product.pk }}" type="number" name="quantity" value="{{ it.qty }}" min="1" class="form-control qty-input">
              <button type="button" class="btn btn-outline qty-increment" aria-label="Tăng">+</button>
            </div>
          </form>
          <a href="{% url 'store:cart_remove' it.product.pk %}" class="cart-item__remove">Xóa</a>
        </div>
      </article>
      {% endfor %}
    </div>
    <aside class="cart-summary">
      <h3 class="section-title">Tóm tắt đơn hàng</h3>
      <div class="summary-line">Tạm tính: <span class="price" id="cart-total">{{ total|vnd }}</span></div>
      <div class="summary-actions">
        <a href="{% url 'store:product_list' %}" class="btn btn-outline w-100">Tiếp tục mua</a>
        <a href="{% url 'store:checkout' %}" class="btn btn-primary w-100">Thanh toán</a>
      </div>
    </aside>
  </div>
{% else %}
  <p>Giỏ hàng trống.</p>
  <a href="{% url 'store:product_list' %}" class="btn btn-primary">Xem sản phẩm</a>
{% endif %}
</section>
{% block scripts %}
<script>
document.querySelectorAll('.cart-item__qty').forEach(form => {
  const input = form.querySelector('.qty-input');
  const dec = form.querySelector('.qty-decrement');
  const inc = form.querySelector('.qty-increment');
  const submitChange = () => {
    if (input.value < 1) input.value = 1;
    form.submit();
  };
  if (dec) dec.addEventListener('click', (e) => { e.preventDefault(); input.stepDown(); submitChange(); });
  if (inc) inc.addEventListener('click', (e) => { e.preventDefault(); input.stepUp(); submitChange(); });
  input.addEventListener('change', submitChange);
});
</script>
{% endblock %}
{% endblock %}
