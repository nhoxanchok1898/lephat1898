{% extends "store/base.html" %}
{% load static %}
{% load humanize %}
{% load watermark_extras %}
{% load price_extras %}
{% block title %}Sản phẩm - Đại lý Sơn Phát Tấn{% endblock %}
{% block content %}
<section class="page-section">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-3">
    <div>
      <nav class="breadcrumb-nav" aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li><a href="{% url 'store:home' %}">Trang chủ</a></li>
          <li>Sản phẩm</li>
          {% if current_category_name %}<li>{{ current_category_name }}</li>{% endif %}
        </ol>
      </nav>
      <h1 class="page-title">Sản phẩm</h1>
      <p class="page-subtitle mb-0">
        <strong>{{ page_obj.paginator.count }}</strong> sản phẩm
        {% if current_category_name %} · Danh mục: {{ current_category_name }}{% endif %}
        {% if q %} · Tìm kiếm: "{{ q }}"{% endif %}
      </p>
      <div class="filter-bar" style="grid-template-columns: 1fr 1fr;">
        <div class="chip-group">
          <span class="chip-label">Thương hiệu:</span>
          <a class="chip {% if not current_brand %}active{% endif %}" href="?{% if current_category %}category={{ current_category }}&{% endif %}{% if q %}q={{ q }}&{% endif %}sort={{ sort }}">
            Tất cả
          </a>
          {% for b in brands %}
            <a class="chip{% if current_brand|default:'' == b.id|stringformat:'s' %} active{% endif %}"
               href="?brand={{ b.id }}{% if current_category %}&category={{ current_category }}{% endif %}{% if q %}&q={{ q }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}">
              {{ b.name }}
            </a>
          {% endfor %}
        </div>
        <div class="chip-group">
          <span class="chip-label">Danh mục:</span>
          <a class="chip {% if not current_category %}active{% endif %}" href="?{% if current_brand %}brand={{ current_brand }}&{% endif %}{% if q %}q={{ q }}&{% endif %}{% if sort %}sort={{ sort }}{% endif %}">
            Tất cả
          </a>
          {% for c in categories %}
            <a class="chip{% if current_category|default:'' == c.id|stringformat:'s' %} active{% endif %}"
               href="?category={{ c.id }}{% if current_brand %}&brand={{ current_brand }}{% endif %}{% if q %}&q={{ q }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}">
              {{ c.name }}
            </a>
          {% endfor %}
        </div>
      </div>
    </div>
    <div class="sort-box">
      <form method="get" class="sort-form">
        {% if current_category %}<input type="hidden" name="category" value="{{ current_category }}">{% endif %}
        {% if current_brand %}<input type="hidden" name="brand" value="{{ current_brand }}">{% endif %}
        {% if q %}<input type="hidden" name="q" value="{{ q }}">{% endif %}
        {% if min_price %}<input type="hidden" name="min_price" value="{{ min_price }}">{% endif %}
        {% if max_price %}<input type="hidden" name="max_price" value="{{ max_price }}">{% endif %}
        {% if on_sale %}<input type="hidden" name="on_sale" value="1">{% endif %}
        {% if new_arrivals %}<input type="hidden" name="new_arrivals" value="1">{% endif %}
        {% if in_stock %}<input type="hidden" name="in_stock" value="1">{% endif %}
        <label for="sort" class="visually-hidden">Sắp xếp</label>
        <select id="sort" name="sort" class="sort-select" onchange="this.form.submit()">
          <option value="">Sắp xếp</option>
          <option value="newest" {% if sort == 'newest' %}selected{% endif %}>Mới nhất</option>
          <option value="price_asc" {% if sort == 'price_asc' %}selected{% endif %}>Giá: Thấp → Cao</option>
          <option value="price_desc" {% if sort == 'price_desc' %}selected{% endif %}>Giá: Cao → Thấp</option>
          <option value="name_asc" {% if sort == 'name_asc' %}selected{% endif %}>Tên: A → Z</option>
          <option value="name_desc" {% if sort == 'name_desc' %}selected{% endif %}>Tên: Z → A</option>
          <option value="popular" {% if sort == 'popular' %}selected{% endif %}>Phổ biến</option>
        </select>
      </form>
    </div>
  </div>
</section>

<section class="page-section">
  <div class="product-grid">
    {% for p in products %}
    <article class="product-card{% if p.quantity <= 0 %} is-out{% endif %}">
      <a href="{% url 'store:product_detail' p.pk %}" class="product-card__thumb">
        {% if p.quantity <= 0 %}<span class="product-card__badge">Hết hàng</span>{% endif %}
        {% if p.image %}
          <img src="{{ p.image|watermarked }}" alt="{{ p.name }}">
        {% else %}
          <img src="{% static 'images/product-placeholder.svg' %}" alt="Chưa có ảnh">
        {% endif %}
      </a>
      <div class="product-card__body">
        {% if p.brand %}<div class="product-card__brand">{{ p.brand.name }}</div>{% endif %}
        <h3 class="product-card__title"><a href="{% url 'store:product_detail' p.pk %}">{{ p.name }}</a></h3>
        <div class="product-card__price">
          {% if p.sale_price %}
            <span class="price-current">{{ p.sale_price|vnd }}</span>
            <span class="price-old">{{ p.price|vnd }}</span>
          {% else %}
            <span class="price-current">{{ p.price|vnd }}</span>
          {% endif %}
        </div>
        <div class="detail-meta" style="font-size:13px;">
          {% if p.volume %}Khối lượng: {{ p.volume }} {% if p.unit_type == 'KG' %}Kg{% else %}L{% endif %}{% endif %}
          {% if p.category %} · {{ p.category.name }}{% endif %}
        </div>
        <div class="product-card__actions">
          {% if p.quantity > 0 %}
            <form method="post" action="{% url 'store:cart_add' p.id %}">
              {% csrf_token %}
              <input type="hidden" name="quantity" value="1">
              <button type="submit" class="btn btn-primary w-100">Thêm vào giỏ</button>
            </form>
          {% else %}
            <button class="btn btn-primary w-100" disabled>Hết hàng</button>
          {% endif %}
          <a class="btn btn-outline-secondary w-100" href="{% url 'store:product_detail' p.pk %}">Xem chi tiết</a>
        </div>
      </div>
    </article>
    {% empty %}
      <div class="no-products">
        <p>Không tìm thấy sản phẩm phù hợp.</p>
        <a href="{% url 'store:product_list' %}" class="btn btn-primary">Xem tất cả sản phẩm</a>
      </div>
    {% endfor %}
  </div>

  {% if page_obj.paginator.num_pages > 1 %}
  <nav aria-label="Phân trang" class="pagination-wrapper">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q }}{% endif %}{% if current_category %}&category={{ current_category }}{% endif %}{% if current_brand %}&brand={{ current_brand }}{% endif %}{% if min_price %}&min_price={{ min_price }}{% endif %}{% if max_price %}&max_price={{ max_price }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}{% if on_sale %}&on_sale=1{% endif %}{% if new_arrivals %}&new_arrivals=1{% endif %}{% if in_stock %}&in_stock=1{% endif %}">Trước</a>
        </li>
      {% endif %}
      <li class="page-item active"><span class="page-link">Trang {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span></li>
      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if q %}&q={{ q }}{% endif %}{% if current_category %}&category={{ current_category }}{% endif %}{% if current_brand %}&brand={{ current_brand }}{% endif %}{% if min_price %}&min_price={{ min_price }}{% endif %}{% if max_price %}&max_price={{ max_price }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}{% if on_sale %}&on_sale=1{% endif %}{% if new_arrivals %}&new_arrivals=1{% endif %}{% if in_stock %}&in_stock=1{% endif %}">Sau</a>
        </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</section>
{% endblock %}
