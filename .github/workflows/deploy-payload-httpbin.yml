name: Deploy Payload HTTPBin Test

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]

jobs:
  httpbin-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Prepare payload
        run: |
          cat > render_payload.json <<'JSON'
{"clearCache": true}
JSON
          cat render_payload.json
      - name: Send payload to httpbin
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          set -euo pipefail
          curl -v -X POST https://httpbin.org/post \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            --data-binary @render_payload.json \
            -D httpbin_headers.txt -o httpbin_body.txt 2>&1 | tee httpbin_stdout.txt || true
          echo "CURL_EXIT=$?" > httpbin_status.txt
          cat httpbin_status.txt
      - name: Upload httpbin artifacts
        uses: actions/upload-artifact@v4
        with:
          name: httpbin-debug
          path: |
            render_payload.json
            httpbin_headers.txt
            httpbin_body.txt
            httpbin_stdout.txt
            httpbin_status.txt
