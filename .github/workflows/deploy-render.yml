name: Deploy to Render

name: Deploy to Render

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate:
    name: Validate Render credentials & service
    runs-on: ubuntu-latest
    outputs:
      valid: ${{ steps.check.outputs.valid }}
    steps:
      - uses: actions/checkout@v4
      - name: Validate secrets
        id: check
        env:
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          set -euo pipefail
          if [ -z "$RENDER_SERVICE_ID" ] || [ -z "$RENDER_API_KEY" ]; then
            echo "secrets_missing=true" >> $GITHUB_OUTPUT
            echo "RENDER_SERVICE_ID or RENDER_API_KEY not set."
            exit 1
          fi
          echo "Checking Render service exists: $RENDER_SERVICE_ID"
          resp=$(curl -sS -w "\nHTTP_CODE:%{http_code}\n" -H "Authorization: Bearer $RENDER_API_KEY" "https://api.render.com/v1/services/$RENDER_SERVICE_ID") || true
          http_code=$(echo "$resp" | awk -F'HTTP_CODE:' '/HTTP_CODE/{print $2}' | tr -d '\r' || true)
          body=$(echo "$resp" | sed -e 's/HTTP_CODE:.*//')
          echo "$body" > validation_body.json
          echo "HTTP_CODE=$http_code" > validation_status.txt
          cat validation_status.txt
          if [ "$http_code" != "200" ]; then
            echo "Service validation failed (HTTP $http_code)" >&2
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "valid=true" >> $GITHUB_OUTPUT

      - name: Upload validation artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: render-validation
          path: |
            validation_body.json
            validation_status.txt

  deploy:
    name: Deploy to Render (robust)
    needs: validate
    if: needs.validate.outputs.valid == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Prepare payload
        run: |
          cat > render_payload.json <<'JSON'
{"clearCache": true}
JSON
          cat render_payload.json
      - name: Trigger deploy with retries and strict checks
        env:
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          # sanitize secrets (remove CR/LF or trailing spaces)
          RENDER_API_KEY_CLEAN=$(printf "%s" "$RENDER_API_KEY" | tr -d '\r' | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
          RENDER_SERVICE_ID_CLEAN=$(printf "%s" "$RENDER_SERVICE_ID" | tr -d '\r' | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')

          echo "Triggering deploy for $RENDER_SERVICE_ID_CLEAN"

          # run curl but do not exit immediately; capture stdout, headers, body and exit code
          set +e
          curl --retry 3 --retry-delay 5 --retry-connrefused -v -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID_CLEAN/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY_CLEAN" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            --data-binary @render_payload.json \
            -D deploy_response_headers.txt \
            -o deploy_response_body.txt \
            --trace-ascii deploy_curl_trace.txt \
            -w "\nHTTP_CODE:%{http_code}\n" 2>&1 | tee deploy_curl_stdout.txt
          curl_exit=$?
          set -e

          # extract HTTP code from stdout or response headers
          http_code=$(grep -oE 'HTTP_CODE:[0-9]{3}' deploy_curl_stdout.txt | tail -n1 | cut -d: -f2 || true)
          if [ -z "$http_code" ]; then
            # try to extract from headers file
            http_code=$(awk '/HTTP/ && /[0-9]{3}/ { for(i=1;i<=NF;i++) if ($i ~ /^[0-9]{3}$/) print $i }' deploy_response_headers.txt | tail -n1 || true)
          fi
          echo "HTTP_CODE=${http_code:-unknown}" > deploy_status.txt
          echo "CURL_EXIT=$curl_exit" >> deploy_status.txt
          cat deploy_status.txt

      - name: Upload deploy artifacts
        uses: actions/upload-artifact@v4
        with:
          name: render-deploy-debug
          path: |
            render_payload.json
            deploy_response_headers.txt
            deploy_response_body.txt
            deploy_curl_trace.txt
            deploy_curl_stdout.txt
      - name: Create issue on failure with logs
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            function readFileTrim(p) { try { return fs.readFileSync(p, 'utf8').trim(); } catch(e) { return '' } }
            const status = readFileTrim('deploy_status.txt');
            const body = readFileTrim('deploy_response_body.txt');
            const trace = readFileTrim('deploy_curl_trace.txt');
            const stdout = readFileTrim('deploy_curl_stdout.txt');
            let failed = false;
            if (!status) failed = true;
            else if (status.includes('HTTP_CODE=unknown')) failed = true;
            else {
              const m = status.match(/HTTP_CODE:(\d{3})|HTTP_CODE=(\d{3})/);
              const code = m ? (m[1]||m[2]) : null;
              if (!code) failed = true; else if (parseInt(code,10) >= 300) failed = true;
            }
            if (!failed) { console.log('No deploy failure detected'); return; }
            const title = `Automated: Render deploy failure for ${process.env.RENDER_SERVICE_ID}`;
            let issueBody = 'Automated deploy failed. Logs attached below.\n\n';
            issueBody += '---\n**deploy_status.txt**\n```\n' + status + '\n```\n\n';
            if (body) issueBody += '**deploy_response_body.txt**\n```\n' + body + '\n```\n\n';
            if (trace) issueBody += '**deploy_curl_trace.txt (first 2000 chars)**\n```\n' + trace.slice(0,2000) + '\n```\n\n';
            if (stdout) issueBody += '**deploy_curl_stdout.txt (first 2000 chars)**\n```\n' + stdout.slice(0,2000) + '\n```\n\n';
            issueBody += 'Suggested actions:\n- Verify repository secrets `RENDER_API_KEY` and `RENDER_SERVICE_ID`.\n- If response indicates `invalid JSON`, inspect `render_payload.json`.\n- Check Render service settings and API key.';
            const { data: issue } = await github.rest.issues.create({ owner: context.repo.owner, repo: context.repo.repo, title, body: issueBody });
            console.log('Created issue:', issue.html_url);
            deploy_status.txt
            curl_exit_code.txt
