name: Deploy to Render

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Trigger Render deploy via API
        env:
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          set -x
          if [ -z "$RENDER_SERVICE_ID" ] || [ -z "$RENDER_API_KEY" ]; then
            echo "RENDER_SERVICE_ID or RENDER_API_KEY not set. Aborting deploy.";
            exit 1;
          fi
          echo "Triggering deploy for service $RENDER_SERVICE_ID"
          payload=$(cat <<'JSON'
{"clearCache": true}
JSON
)

          echo "$payload" > render_payload.json
          echo "Saved payload to render_payload.json"

          # send request and capture headers + body
          resp=$(curl -sS -w "\nHTTP_CODE:%{http_code}\n" -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            --data-binary "$payload")

          echo "$resp" > render_response.txt
          echo "Saved response to render_response.txt"
          cat render_response.txt || true
          ls -la || true

      - name: Upload Render debug artifacts
        uses: actions/upload-artifact@v4
        with:
          name: render-debug
          path: |
            render_payload.json
            render_response.txt
