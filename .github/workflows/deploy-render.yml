name: Deploy to Render

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Trigger Render deploy via API
        env:
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          set -x
          if [ -z "$RENDER_SERVICE_ID" ] || [ -z "$RENDER_API_KEY" ]; then
            echo "RENDER_SERVICE_ID or RENDER_API_KEY not set. Aborting deploy.";
            exit 1;
          fi
          echo "Triggering deploy for service $RENDER_SERVICE_ID"
          payload=$(cat <<'JSON'
{"clearCache": true}
JSON
)

          echo "$payload" > render_payload.json
          echo "Saved payload to render_payload.json"

          # send request: write headers/body/trace to files AND print verbose output to console
          curl -v -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            --data-binary @render_payload.json \
            -D render_response_headers.txt \
            -o render_response_body.txt \
            --trace-ascii render_curl_trace.txt \
            -w "\nHTTP_CODE:%{http_code}\n" 2>&1 | tee render_curl_stdout.txt || true

          echo "Saved response headers to render_response_headers.txt"
          echo "Saved response body to render_response_body.txt"
          echo "Saved curl trace to render_curl_trace.txt"
          echo "Saved verbose stdout to render_curl_stdout.txt"
          echo $? > curl_exit_code.txt || true
          ls -la || true

      - name: Upload Render debug artifacts
        uses: actions/upload-artifact@v4
        with:
          name: render-debug
          path: |
            render_payload.json
            render_response_headers.txt
            render_response_body.txt
            render_response_status.txt
            render_response_headers.txt
            render_response_body.txt
            render_curl_trace.txt
            render_curl_stdout.txt
            curl_exit_code.txt
